<html>
<head>
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8">
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>2. Template anlegen</h1>
In einem Template beschreibt man VideLibri, wie die Internetseite einer Bücherei aufgebaut ist. Jedes dieser Template besteht aus einer Liste von Aktionen, welche beim Ausführen bestimmte Internetseiten runterladen und Daten extrahieren, die wiederum von VideLibri angezeigt werden (z.B.: Mediendaten), oder später in der Aktion wiederverwendet werden (z.B.: der Link zur nächsten Seite).<br><br>

Um ein Template zu erstellen, muss man ein Verzeichnis namens data\libraries\templates\xxxxx anlegen, wobei xxxxx der Name des Templates ist.<br>
Dort erstellt man dann wiederum eine XML-Datei namens template mit dieser Struktur:


<pre>
&lt;actions>

&lt;action id="connect">
  &lt;page url="...url..." templateFile="Datei, die das Einzelseitentemplate enthält (siehe <a href="seiten.html">Schritt 3</a>) (optional)"  >
    &lt;post name="post variable name"> Daten (optional) &lt;/post>
    ...
    &lt;template>Einzelseitentemplate (siehe <a href="seiten.html">Schritt 3</a>) (optional) &lt;/template>
  &lt;/page>
  
  ...
  
&lt;/action>

&lt;action id="update-(all|single)">
 
  ...

&lt;/action>

&lt;action id="renew-(all|list|single)"> 
&lt;/action>

...

&lt;action id="search">
&lt;/action>

&lt;action id="search-next-page">
&lt;/action>

&lt;action id="search-details">
&lt;/action>


&lt;/actions>

</pre>


Ein solches <code>actions</code>-Template besteht aus einer Liste von <code><b>&lt;action></b></code> Aktionen, die jeweils beschreiben, welche Seiten aufzurufen sind.  VideLibri unterstützt die folgenden Aktionen, wobei es nicht nötig ist, alle anzugeben:

<ul>
<li><code>connect</code> wird einmal ausgeführt, um eine Verbindung zur Bücherei herzustellen. <br>Die Variablen <code>$username</code> und <code>$password</code> enthalten die entsprechenden Benutzerdaten. Außerdem kann man auf alle in der Büchereimetadatendatei von Schritt 1 definierten Variablen zugreifen.</li>
<li><code>update-all</code> wird jedesmal ausgeführt, um die Medienliste zu aktualisieren und ist die einzige notwendige Aktion.<br>Es sind dieselben Variablen, wie beim Aufruf <code>connect</code> definiert, sowie alle Variablen, die <i>von</i> <code>connect</code> definiert wurden.</li>
<li><code>update-single</code> wird direkt nach <code>update-all</code> ausgeführt und zwar einmal für jedes Buch, welches <code>update-all</code> gefunden hat. <br>Die Variable <code>$book</code> enthält das jeweilige Buch.</li>
<li><code>renew-all</code> wird ausgeführt, wenn alle Medien verlängert werden sollen.</li>
<li><code>renew-list</code> wird zum Verlängern von mehreren Medien ausgeführt. <br>Die Variable <code>$renew-books</code> enthält die Liste aller zu verlängernden Bücher. </li>
<li><code>renew-single</code> wird ausgeführt, um ein einzelnes Buch zu verlängert.<br>Die Variable <code>book</code> enthält das jeweilige Buch.</li>
<li><code>search</code> wird ausgeführt, um im Katalog zu suchen.<br>Die Variable <code>book</code> enthält die Parameter für eine Suchanfrage</li>
<li><code>search-next-page</code> wird ausgeführt, um die nächste Seite der Suchergebnisse zu laden.</li>
<li><code>search-details</code> wird ausgeführt, um die Details zu einem Suchergebnis abzufragen.<br>Die Variable<code>book</code> enthält das abzufragende Suchergebnis.</li>

</ul>
<p>
Für ein einfaches Anzeigen aller ausgeliehenen Bücher, muss man nur <code>update-all</code> definieren. 
<p>
<code>update-single</code> ist insbesondere nicht nötig, wenn <code>update-all</code> bereits genügend Information über alle Bücher ermitteln kann. (aber viele Büchereien zeigen auf der Gesamtübersicht nicht an, ob ein Buch verlängerbar ist.)<br>
<code>renew-all</code>, <code>renew-list</code>, <code>renew-single</code> werden nur benötigt, wenn die Bücher tatsächlich verlängert werden sollen. Es ist dabei nicht nötig, alle anzugeben. Wenn es zum Beispiel <code>renew-list</code> nicht gibt, und mehrere Bücher verlängert werden sollen, ruft VideLibri automatisch <code>renew-single</code> für jedes dieser Bücher einzeln auf. Gibt es auch <code>renew-single</code> nicht, wird in diesem Fall <code>renew-all</code> aufgerufen. <br>
<code>search</code>, <code>search-next-page</code>, <code>search-details</code> werden nur für die Suche im Katalog benötigt, und für die Anzeige der Ausleihen ignoriert.



<p>Jede Aktion definiert eine Liste von <code><b>&lt;page></b></code>-Elementen, die alle  der Reihe nach aufgerufen werden. Das Attribut  <code>url</code> gibt jeweils die Addresse der Seite an. Mittels <code>&lt;post name="..Name.." value="..Wert.."/></code> können http-Postvariablen definiert werden, die beim Seitenaufruf übertragen werden sollen. (Hinweis: ältere Versionen haben stattdessen <code>&lt;post name="..Name..">..Wert..&lt;/post></code> verwendet, was in Zukunft nicht mehr unterstützt werden wird.). Gibt es keine <code>&lt;post></code>-Elemente wird ein GET-Request gesendet. Außerdem werden Sonderzeichen in <code>name</code> und <code>value</code> im URL-Format kodiert, es sei denn es ist kein <code>name</code>-Attribut angegeben (was nützlich ist, um mehrere Werte anzugeben). <br>
Für jede dieser Seiten kann ein <a href="seiten.html">Seiten-Template</a> angelegt werden, um die in der Seite enthaltenden  Informationen, wie Bücherlisten oder die nächsten URLs, auszulesen. Es kann entweder direkt in einem <code>&lt;template></code> Element definiert werden, oder in einer Extradatei über das <code>templateFile</code>-Attribut angegeben werden (die Dateien werden im gleichen Verzeichnis wie die template-Datei gesucht).
<br>(Es gibt auch ein <code>test</code>-Attribut, der eine Bedingung für diese Seite angibt. Diese Bedingung ist ein XPath-Ausdruck, und wenn er zu <code>false()</code> ausgewertet wird, wird die Seite ignoriert)


<p>Zudem gibt es auch <code><b>&lt;variable></b></code>-Elemente, mit denen im Template neue Variablen definiert werden können: <code>&lt;variable name="foobar" value="123"/></code> definiert eine Variable mit Name <code>$foobar</code> und dem Stringwert <code>123</code>. Alternativ kann eine Variable mit <code>&lt;variable name="foobar">123&lt;/variable></code> definiert werden, wodurch eine Variable mit Name <code>$foobar</code> und dem <i>Integer</i>wert <code>123</code> definiert wird. In diesem Fall kann statt 123 jeder beliebige XPath-Ausdruck angegeben werden (z.B.: um reguläre Ausdrücke auf andere Variablen anzuwenden). Das <code>value</code>-Attribut definiert aber immer einen String.

<p>Auf alle definierten Variablen, kann innerhalb von anderen XPath-Ausdrücken mit <code>$variablename</code> zugegriffen werden. Außerdem wird in string-Attributen (wie url, oder value) jedes Vorkommen von <code>{$variablename}</code> durch den Wert der Variablen ersetzt (Warnung: In älteren VideLibri-Versionen &lt;= 1.301 wurde stattdessen <code>$variablename;</code> verwendet). <br>
VideLibri verwendet eine erweiterte XPath-Syntax, die auch Objektvariablen unterstützt: Wenn z.B.: die Variable <code>$book</code> die Daten zu einem Buch enthält, kann mittels <code>$book.title</code> auf den Buchtitel, und mittels <code>$book.author</code> auf den Autor zugegriffen werden. (siehe die Dokumentation für  <a href="seiten.html">Seiten-Template</a> für eine Übersicht über alle Buch-Eigenschaften)<br>
Diese Objekterweiterung wird auch in einem Spezialfall von den <code>url</code>-Attributen von <code>&lt;page></code> verwendet: Wenn <code>url="{$variable}"</code> auf eine einzige Variable verweist und diese Variable ein Objekt ist, wird die Eigenschaft <code>$variable.url</code> als URL für den Seitenaufruf verwendet. Desweiteren wird <code>$variable.post</code> für die Postdaten verwendet. Ein entsprechendes Objekt kann zum Beispiel mit der Funktion <code>form(//form[1])</code> in einem XPathausdruck erstellt werden (dies würde die Daten der ersten Form auf einer Seite enthalten). <br>
Die Variable <code>$renew-books</code> der <code>renew-list</code>-Aktion enthält eine Liste von Buchobjekten, und lässt sich am besten mit XPath-<code>for</code>-Ausdrücken verwenden. Z.B.: Wenn jedes Buchobject eine (benutzerdefinierte) Eigenschaft <code>renewid</code> hat, die auf true gesetzt werden muss, kann eine Variable für das Postrequest mit folgendem XPath-Ausdruck erzeugt werden:
<code>&lt;variable name="book-list">string-join(for $book in $renew-books return concat($book.renewid, ";=true"), "&amp;amp;")&lt;/variable> </code>. (siehe eine Standardreferenz über XPath für Details).  <br>
(in älteren Versionen von VideLibri, die XPath-for noch nicht unterstützen, gab es dafür ein <code>singleBookStr</code>-Attribut von action. Wenn es zum Beispiel auf <code>$book.renewid;=true</code> gesetzt wurde, wurde genau die Variable vom obigen Beispiel definiert)<br>


<p>Es ist gibt auch einen  <code>&lt;<b>call action="name"/></b></code> Befehl, um Aktionen von anderen Aktionen aus aufzurufen. Dabei werden auch neue, benutzerdefinierte Aktionen mit anderen Namen unterstützt.


<p>Und schließlich gibt es ein <code><b>&lt;loop></b></code>-Element mit diesen beiden Syntaxformen: <code>&lt;loop var="varname" list="eine Liste"/></code> und <code>&lt;loop test="Bedingung"/></code>.<br>
Die erste Form wiederholt die Kindelemente von <code>loop</code> wie ein üblicher foreach-Ausdruck für jeden Wert in der Liste <code>eine Liste</code>, wobei der jeweilige Wert der Variable <code>$varname</code> zugewiesen wird. Die zweite Form, wiederholt solange, wie <code>test</code> true ist. <br>
Sowohl <code>list</code> wie auch <code>test</code> erlauben beliebige XPath-Ausdrücke.<br>
(dieses Element macht <code>update-single</code> und <code>renew-single</code> im Grunde redunant.)


<p><br>

Unabhängig von VideLibri können diese Templates auch mit <a href="http://videlibri.sourceforge.net/xidel.html">Xidel</a>  getestet werden, und mit dem <a href="http://userscripts.org/scripts/show/144991">Xidelscript</a> kann ein Template für eine einzelne Aktion automatisch durch Markieren der jeweiligen Links/Buchtitel in Firefox erstellt werden (beides auf Englisch. Und üblicherweise muss es aber noch per Hand nachgebessert werden. Und das Skript zusammen mit Xidelversion 0.5 verwenden noch die alte Syntax für post-Daten). 

</body>
