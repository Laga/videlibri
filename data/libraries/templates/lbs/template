<actions>

<meta>
  <description>Template das PICA-System mit LBS zum Benutzerkontozugriff, 체blicherweise von den GBV Bibliotheken verwendet</description>
  <variable name="server"><description>Serveraddresse, inklusive Protokoll und Parameter (z.B.: http://katalog.uni-hildesheim.de/) </description></variable>
  <variable name="picadb" default="1"><description>Datenbanknummer, wenn mehrere Datenbanken auf demselben Server liegen</description></variable>    
  <variable name="searchKeysOverride" default="tit;prs;isb;jah;slw"><description>Abk체rzungen der Suchschl체ssel bei Katalogsuchen</description></variable>
</meta>


<action id="connect">
  <s>loggedIn := false()</s>
</action>

<action id="internal-login">
  <if test="not($loggedIn)">
    <s>follow1 := (), follow2 := ()</s>
    <page url="{$server}/LBS_WEB/borrower/borrower.htm?USR={1000 + get('picadb', 1)}&BES={get('picadb', 1)}&LAN=DU">
      <template>
<DIV id="main_wrapper"><t:s>vl:delete-current-books()</t:s>
  <FORM>{follow1 := form(., {"j_username": $username, "j_password": $password})}</FORM>
</DIV>

      </template>
    </page>

  <page url="{$follow1}">
    <template>
<BODY>
  <DIV class="topbox">
    <FORM class="topbox">
      <DIV class="tabbar">
        <DIV class="navlink">
          <A>{follow2 := @href}</A>
        </DIV>
      </DIV>
    </FORM>
  </DIV>
</BODY>

    </template>
  </page>

    <s>loggedIn := true()</s>
  </if>
</action>

<action id="update-all">
  <call action="internal-login"/>
  

  <page url="{$follow2}">
    <template>

<FORM name="loansForm" id="loansForm">{renew-form:=form(., {"renew": "Verl채ngern"}), vl:delete-current-books()}
  <DIV class="bodydiv">
    <TABLE class="resultset">
 
         
          <TR>
            <td class="rec_checkbox">
              <input type="checkbox" name="volumeNumbersToRenew">{book:={"renewId": @value, "statusId": if (@disabled) then "critical" else "curious"}}</input>
            </td>
            <TD class="rec_title">
              <DIV>
                <TABLE class="titlelist">
                  <TR>
                    <TD class="rec_data">
                      <SPAN class="titleLine">{
                        book.title := extract(.,  "^[^/]*"),
                        book.author:= extract(.,  "/([^(]*)", 1),
                        book.year  := extract(.,  "/.*\((.*)\)", 1)
                        }</SPAN>
                    </TD>
                  </TR>
               <!-- </TABLE>
                <TABLE class="titlelist"> ?? on the page, fails template-->
                  <TR/>
                  <TR>
                    <TD class="rec_data"/>
                    <TD class="rec_data">
                      <SPAN>{book.duedate := parse-date(., 'd.m.yyyy')}</SPAN>
                    </TD>
                  </TR>
                  <TR/>
                  <TR>
                    <TD class="rec_data"/>
                    <TD class="rec_data">
                      <SPAN>{book.id := .}</SPAN>
                    </TD>
                  </TR>
                  <tr>{book.status := .}</tr>
                  <tr>{book.status := concat($book.status, " ", .)}</tr>
                  <SPAN class="error">{book.status := concat(., " ", $book.status)}</SPAN>?
                </TABLE>
                <SPAN class="error">{book.status := concat(., " ", $book.status)}</SPAN>?
                <t:s>book.statusId := $book.statusId</t:s>
              </DIV>
            </TD>
          </TR>+
       
 
    </TABLE>
  </DIV>
</FORM>

    </template>
  </page>

</action>

<action id="renew-list">  
  <s>renew := form-combine($renew-form, for $book in $renew-books return {"volumeNumbersToRenew": $book.renewId})</s>
  
  <page url="{$renew}"/>

  <call action="update-all"/>
</action>











<action id="search-connect">
  <variable name="db" value="DB={get('picadb', 1)}"/>
  <variable name="loanServer" value="{$server}/loan/{$db}/LNG=DU/HTML=Y/"/>

</action>

<action id="search">
  
  <variable name="searchKeys">
  tokenize(get("searchKeysOverride", "tit;prs;isb;jah;slw"), ";")
  </variable>
  
  <variable name="searchOptions">
  encode-for-uri( string-join(
    (if ($book.title != "")    then concat($searchKeys[1], " ", $book.title)    else (),
     if ($book.author != "")   then concat($searchKeys[2], " ", $book.author)   else (),
     if ($book.isbn != "")     then concat($searchKeys[3], " ", $book.isbn)     else (),
     if ($book.year != "")     then concat($searchKeys[4], " ", $book.year)     else (),
     if ($book.keywords != "") then concat($searchKeys[5], " ", $book.keywords) else ()), "&amp;"))
  </variable>


  <page url="{$server}/{$db}/HTML=Y/CMD?ACT=SRCHA&IKT=1016&SRT=RLV&TRM={$searchOptions}" templateFile="searchList"></page>
  
  <page test="$singleResult" url="{$server}/{$db}/CMD?ACT=SRCHA&IKT=1016&SRT=RLV&TRM={$searchOptions}" templateFile="searchDetails"></page>
  
  <variable name="search-next-page-available">$nextPage</variable>
</action>

<action id="search-next-page">
  <page url="{$nextPage}" templateFile="searchList"></page>

  <variable name="search-next-page-available">$nextPage</variable>
</action>


<action id="search-details">
  <page url="{$book.home-url}" templateFile="searchDetails"></page>
</action>


</actions>
