<?xml version="1.0" encoding="UTF-8"?>
<actions>


<meta>
  <description>Template für das Libero-System, version 5.4</description>
  <variable name="baseurl"><description>Serveraddresse (inklusive Protokoll)</description></variable>
  <variable name="loginBaseurl" default=""><description>Serveraddresse für Kontozugriff(inklusive Protokoll)</description></variable>
</meta>

<action id="connect">
  <variable name="baseurl">get("loginBaseurl", $baseurl)</variable>
  <page url="{$baseurl}WebOpac.cls" templateFile="start"/>
  <page url="{$baseurl}WebOpac.cls?VERSION=2&amp;ACTION=MEMBERSERV&amp;RSN=0&amp;DATA={$data}&amp;TOKEN={$token}&amp;Z=1&amp;NewBreadCrumb=1&amp;{$logintoken}">
    <template><form><input name="usernum"/><t:s>update-form := form(., {"usernum": $username, "password": $password, "btnlogin": "LOGIN"})</t:s></form></template>
  </page>
</action>

<action id="update-all">
  <page url="{$update-form}" templateFile="update"/>
</action>

<action id="renew-list">
  <variable name="book-list">string-join(for $book in $renew-books return x"{$book.extendid}=1", "&amp;")</variable>
  
  <page url="{$baseurl}WebOpac.cls">
    <post name="MGWCHD" value="0"/>
    <post name="TOKEN" value="{$token}"/>
    <post name="TOKENX" value="{$tokenx}"/>
    <post name="DATA" value="{$data}"/>
    <post name="usercode" value=""/>
    <post name="VERSION" value="{$version}"/>
    <post name="ACTION" value="MEMSLFISS"/>
    <post name="bno" value="{$username}"/>
    <post name="mid" value="{$mid}"/>
    <post value="{$book-list}"/>
  </page>
  <call action="update-all"/>
</action>

<action id="cancel-list">
  <variable name="book-list">string-join(for $book in $cancel-books return $book.cancelId, "&amp;")</variable>
  <s>f := $cancelForm, f.post := concat($f.post, "&amp;", $book-list)</s>
  <page url="{$f}">
  <template>
    <b>Löschen der Benutzervormerkung wird bearbeitet</b>
    <b>Transaktion verarbeitet</b>
  </template>
  </page>
</action>

<action id="search-connect">
  <page url="{$baseurl}WebOpac.cls">
  <template>
    <t:switch-prioritized>
      <a t:condition="contains(@href, 'WebOpac.cls')">Erweiterte Suche<t:s>search:=@href</t:s></a>
      <title>LIBERO WebOPAC Erweiterte Suche<t:s>search:=$url</t:s></title>
      <font>Server ist zurzeit nicht verfügbar<t:s>vl:raise(.)</t:s></font>
    </t:switch-prioritized>
  </template> <!-- condition is for dresden which has a link "erweiterte suche in der Hilfe" -->
  </page>

  <variable name="search-keys">{"author": "kb", "title": "k", "keywords": "kj", "isbn": "i"}</variable>

  <page url="{$search}">
  <template><form>
    {search-form := form(., .//input[@type="submit"]), keyword-key := ""}
    
    <option>Schlagwörter<t:s>search-keys.keywords := @value</t:s></option>?
    <option>Schlagwort<t:s>search-keys.keywords := @value</t:s></option>?
    
    <select name='LIMLOC' t:optional="true">
    {search-branches := option, search-branch-values := option/@value}
    </select>?
  </form></template>
  </page>
</action>


<action id="search">  
  <s>
     i := 1, 
     f := $search-form,
     f.post := uri-combine($f.post, (
       if (boolean($book.year)) then 
         if (contains($book.year, "-")) then 
           {"YEARFROM": normalize-space(substring-before($book.year, "-")), "YEARTO": normalize-space(substring-after($book.year, "-"))} 
         else 
           {"YEARFROM": $book.year, "YEARTO": $book.year} 
       else (),
       if (get("search-branch-values", ())[get("search-branch-id", 0)]) then {"LIMLOC": $search-branch-values[$search-branch-id]} else (),
       for $key in jn:keys($book) return if (boolean($book($key)) and exists($search-keys($key))) then (
         {x"TERM_{$i}": $book($key), x"USE_{$i}": $search-keys($key)},
         (i := $i + 1)[2]
       ) else ()
    )
     )
  </s>
  <page url="{$f}" templateFile="searchList"/>
  
</action>

<action id="search-next-page">
  <page url="{$next-page}" templateFile="searchList"/>
</action>

<action id="search-details">
  <page url="{$book._detail-url}" templateFile="searchDetails"/>
</action>

<action id="order-confirm-single"> 
  <page url="{$book._order-url}">
    <template><form>{f := form(., {"usernum": $username, "password": $password})}</form></template>
  </page>
  <page url="{$f}">  
    <template>
     <t:switch>
      <form>
        {issuePoints := (), confirm := form(.)}
        <select name='BRANCH'>
          {book.orderConfirmationOptionTitles := option, issuePoints := $book.orderConfirmationOptionTitles/@value}
        </select>
        
        {if (count($issuePoints) > 1 ) then book.orderConfirmation := "Wohin soll das Buch vorbestellt werden?"
         else book.orderConfirmation := ""
        }
      </form>
      <ul class='SysMsgList'>
        <b>Die Transaktion wurde abgelehnt</b>
        <t:s>vl:raise(.)</t:s>
      </ul>
    </t:switch></template>   
  </page>
</action>


<action id="order-single"> 
  <if test="boolean($book.orderConfirmation)">
    <s>confirm.post := uri-combine($confirm.post, {"BRANCH": $issuePoints[$book.choosenConfirmation*1]})</s>
  </if>
  <page url="{$confirm}">
  <template><t:switch>    
    <b>Ihre Vormerkung wurde vorgenommen</b>
    <ul class="SysMsgList">
      <b>Für diesen Titel konnte keine Vormerkung eingetragen werden</b>
      <t:s>vl:raise(.)</t:s>
    </ul>    
  </t:switch></template>
  </page>
</action>


<action id="catalogue">
  <variable name="url" value="{$baseurl}WebOpac.cls"/>
</action>


</actions>
