<?xml version="1.0" encoding="UTF-8"?>
<actions>

<meta>
  <description>Template f端r das Primo-System</description>

  <variable name="baseurl"><description>volle Serverurl, inklusive trailing slash (z.B.: http://portal.ub.tu-berlin.de/primo_library/libweb/action/)</description></variable>

  <variable name="login-url-1"><description>Login-URL f端r Interne (Studenten)</description></variable>
  <variable name="login-url-2"><description>Login-URL f端r Externe</description></variable>
  
  <variable name="institute"><description>(veraltet) Institutsid der B端cherei im Primosystem</description></variable>
  
</meta>


<action id="connect">
</action>

<action id="update-all">
  <s>$request := get("login-url-" || (if ($type ge 1) then $type else 1), ()),
     if ($request) then () else $request := get("login-url")
  </s>
  
  <s>i := 1, datasend := false()</s>
  <!-- follow links till we reach the login page -->
  <loop test="$i < 10">  
    <page url="{$request}"/>
    <pattern><t:switch prioritized="true">
      
      <div  t:test="$datasend" class="EXLPRMLoginCardContentError">{vl:raise(.)}</div>
      <div  t:test="$datasend" class="error">{vl:raise(.)}</div>
      <span t:test="$datasend" class="login-error">{vl:raise(.)}</span>
      <font t:test="$datasend" color="red">{vl:raise(.)}<!--htw--></font>
      <h2 t:test="$datasend" style="color: red;">{vl:raise(.)}<!--fu--></h2>
      <p t:test="$datasend" class="error">{vl:raise(.)}<!--hu intern--></p>
      
      <form>
        <input name="username"/>
        {request := form(., {"username": $username, "password": $password} ), datasend := true()}
      </form>
      <form>
        <input name="j_username"/>
        {request := form(., {"j_username": $username, "j_password": $password, "_eventId_proceed": .//button[@name = "_eventId_proceed"]/@value} ), datasend := true()}
      </form>
      <DIV class="EXLMyAccountContainer" id="exlidMyAccountContainer"> <DIV class="EXLMyAccountMainContainer"/> 
        {i := 10000}<!--logged in-->
      </DIV>
      <a t:condition="contains(@href, 'myAccountMenu.do')">{$request}</a>
      <meta http-equiv="refresh">{$request}</meta>    
      <form>{$request := form(.)}</form>
      <a>{$request}</a>
    </t:switch></pattern>
    <s>$i := $i + 1</s>    
  </loop>
    
  <if test="$i < 100">
  <s>vl:raise("Zuviele Weiterleitungen beim Login. ")</s>
  </if>
    
  <s>videlibri:delete-current-books()</s>
  <pattern href="list"/>

  <page url="{$orderPage}"/>
  <pattern href="list"/>
  
<!--  <error templateFile="loginError"/>-->
</action>

<!--
<action id="update-single">
  <page url="{$book.detailUrl}">
  <template>
    <DIV class="EXLMyAccountContainer" id="exlidMyAccountContainer">
      <template:meta default-text-matching="regex"/>
      <DIV class="EXLMyAccountMainContainer">
        <H1>Details of loan:|Details der Ausleihe:</H1>
        <TABLE class="EXLMyAccountTableDetails">
          <TR><TH>Year:|Jahr:</TH><TD>{book.year:=.}</TD></TR>
          <TR><TH>Call number:|Signatur:</TH><TD>{book.id:=.}</TD></TR>
          <TR t:optional="true"><TH>Loan date:|Ausleihdatum:</TH><TD>{book.issueData:=parse-date(., "dd.mm.yyyy|dd/mm/yyyy")}</TD></TR>
        </TABLE>
      </DIV>
    </DIV>
  </template>
  </page> 
</action>
-->


<action id="renew-list">
  <loop var="b" list="$renew-books">
    <page url="{$b._renewUrl}">
    </page>
  </loop>
  <call action="update-all"/>
</action>

<action id="cancel-list">
  <loop var="b" list="$cancel-books">
    <page url="{$b._cancelUrl}">
    </page>
  </loop>
  <call action="update-all"/>
</action>




<action id="search">
  
  <variable name="search-keys">{"author": "creator", "title": "title", "keywords": "subject", "isbn": "isbn", "year": "cdate"}</variable>

  <s>redirect:=()</s>

  <page url="{$baseurl}search.do?mode=Advanced&amp;fromLogin=true&amp;vid={$institute}" templateFile="searchStart"/>
  
  <page url="{$redirect}" templateFile="searchStart"/>

  <page url="{$form}" templateFile="searchList"/>
  
  <page url="{$form}" test="$waiting" templateFile="searchList"/>
  
</action>


<action id="search-next-page">
  <page url="{$search-next}" templateFile="searchList">
  </page>
</action>

<action id="search-details">
  <page url="{$book.home-url}" templateFile="searchDetails"/>
  <page url="{$book.locations-url}" templateFile="searchDetailsLocations"/>

</action>

</actions>
