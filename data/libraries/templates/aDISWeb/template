<?xml version="1.0" encoding="UTF-8"?>
<actions>
<action id="connect"></action>

<action id="update-all">

  <page url="https://{$server}/aDISWeb/app{get('startparams', '')}" templateFile="connected"/>

  <page url="{$connectPage}">
  <template><template:switch>
    <a><span>Benutzerkonto</span>{loginForm:=@href}</a>
    <a><span>Mein Konto</span>{loginForm:=@href}</a>
  </template:switch>
  </template>
  </page>

  <page url="https://{$server}/{$loginForm}">
    <template><form>{
      loginFormPost := form(., {"$Textfield": $username, "$Textfield$0": $password})
    }</form></template>
  </page>


  <page url="{$loginFormPost}">
    <post name="textButton" value="Anmeldung abschicken"/>
    
    <template>
      <form>{loginFormPost:=form(.)}
      <h1>Sie sind angemeldet.</h1>
      </form>
      
    </template>
  </page>
  
  
  <page url="{$loginFormPost}">  
    <template>
    <t:switch>
    <a>Ausleihen zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    <a>Ausleihe zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    </t:switch>
      <!--<t:s>kontoPage := filter(@href, "(.*)&amp;requestCount", 1),
           requestCount := filter(@href, "requestCount=([0-9]+)", 1)
      </t:s>-->
    </template>
  </page>


  <page url="https://{$server}/{$kontoPage}">
    <template>
      <DIV class="aDISMaske"><!-- this page shows the books, but not if they are renewable. need to click on a button for that -->
      <FORM>
      {extendFormPost := form(., jn:object((.//input[@type = "submit" and contains(@value, "arkierte") and contains(@value, "ngern")])[1]/{string(@name): @value})),
      extendFormPost.post := replace($extendFormPost.post, "[a-zA-Z0-9]+=on&", "")
      }
      
        
      <DIV class="fsgrp">
      <DIV class="rTable_div">
      <template:read var="delete-current-books()"/>
      <TABLE class="rTable_table">
      <t:loop>
      <TR>
      <TD>{book := object(),
           book.extendid := encode-for-uri(input/@name)
           }</TD>
      <TD>{book.duedate := parse-date(., "dd.mm.yyyy")}</TD>
      <TD>{book.libraryBranch := .}</TD>
      <TD>{book.category := filter(text(), "\[(.*)\]", 1),  
           book.title :=  if (contains(text(), "]")) then filter(text(), "(\] )(.*)", 2) else text(),
           if (contains($book.title, "/")) then (
             $book.author := substring-after($book.title, "/"),
             $book.title := substring-before($book.title, "/")
           ) else ()
           }<BR/>
          {preid := text()}<BR/>
          {book.id := concat($preid,":",text())}</TD>
      <TD>{book.status := deep-text("   ")}
          <t:if test="matches(., x'((nicht +verl.*ngerbar|Keine Verl.*gerung +m.*glich).*Stand +{string-join(reverse(tokenize(current-date(), '-')), '[.]')})|(Max. +Anzahl +der +Verl.*erreicht)','i')">
            {book.statusId := "critical"}
          </t:if>
      </TD>
      </TR>
      </t:loop>
      </TABLE>

      </DIV>
      </DIV>


      </form>
      </div>
    </template>
  </page>
  
  
</action>

<action id="renew-list">
  <variable name="book-list">string-join(for $book in $renew-books return x"{$book.extendid}=on", "&amp;")</variable> 
  <page url="{$extendFormPost}">
    <post value="{$book-list}"/>
  </page>
  
  <call action="update-all"/>
</action>













<action id="gotoindex">
  <loop test="$firstIndex > $targetIndex">
    <page url="{$form.url}" templateFile="searchBasicForm">
      <post value="{$form.post}&%24Toolbar_4.x=0&%24Toolbar_4.y=0"/>
    </page>
  </loop>

  <loop test="$lastIndex < $targetIndex and $targetIndex < $search-result-count">
    <page url="{$form.url}" templateFile="search">
      <post value="{$form.post}&%24Toolbar_5.x=0&%24Toolbar_5.y=0"/>
    </page>
  </loop>
  
</action>

<action id="search">
  <variable name="connected">false()</variable>
  
  <page url="https://{$server}/aDISWeb/app{get('startparams', '')}" templateFile="connected"/> <!-- some libraries log in directly, some redirect -->
  <page url="{$connectPage}" test="not($connected)" templateFile="connected"/>
  
  <page url="{$seachPage}" templateFile="searchInputForm"/>

  <variable>lastSearchedIndex := 0, search-next-page-available := ()</variable>

  <page url="{$startSearch}" templateFile="search"/>
</action>

<action id="search-next-page">
  <variable name="targetIndex">$lastSearchedIndex + 1</variable>
  <choose>
    <when test="get('goback', ()) and $firstIndex <= $targetIndex and $targetIndex <= $lastIndex">
      <page url="{$goback}" templateFile="search"/>
    </when>
    <otherwise>
      <call action="gotoindex"/>
    </otherwise>
  </choose>
</action>


<action id="search-details">
  <variable name="targetIndex">$book._index * 1</variable> <call action="gotoindex"/>

    <page url="{$form.url}" templateFile="searchDetails">
    <post>{replace($form.post, "selected=", concat("selected=", $book._searchId))}</post>
  </page>
  
  <page url="{$goback}" templateFile="searchBasicForm"/>
  
</action>

<action id="catalogue">
  <variable name="url" value="https://{$server}/aDISWeb/app{get('startparams', '')}"/>
</action>

</actions>
