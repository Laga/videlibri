<?xml version="1.0" encoding="UTF-8"?>
<actions>
<action id="connect"></action>

<action id="update-all">

  <page url="https://{$server}/aDISWeb/app{get('startparams', '')}" templateFile="connected"/>

  <page url="{$connectPage}">
  <template>
    <a><span>Benutzerkonto</span>{loginForm:=@href}</a>
    <a><span>Mein Konto</span>{loginForm:=@href}</a>
  </template>
  </page>

  <page url="https://{$server}/{$loginForm}">
    <template><form>{
      loginFormPost := form(., {"$Textfield": $username, "$Textfield$0": $password})
    }</form></template>
  </page>


  <page url="{$loginFormPost}">
    <post name="textButton" value="Anmeldung abschicken"/>
    
    <template>
      <form>{loginFormPost:=form(.)}
      <h1>Sie sind angemeldet.</h1>
      </form>
      
    </template>
  </page>
  
  
  <page url="{$loginFormPost}">  
    <template>
    <t:switch>
    <a>Ausleihen zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    <a>Ausleihe zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    </t:switch>
      <!--<t:s>kontoPage := filter(@href, "(.*)&amp;requestCount", 1),
           requestCount := filter(@href, "requestCount=([0-9]+)", 1)
      </t:s>-->
    </template>
  </page>


  <page url="https://{$server}/{$kontoPage}">
    <template>
      <DIV class="aDISMaske"><!-- this page shows the books, but not if they are renewable. need to click on a button for that -->
      <FORM>
      {extendFormPost := form(., jn:object((.//input[@type = "submit" and contains(@value, "arkierte") and contains(@value, "ngern")])[1]/{string(@name): @value})),
      extendFormPost.post := replace($extendFormPost.post, "[a-zA-Z0-9]+=on&", "")
      }
      
        
      <DIV class="fsgrp">
      <DIV class="rTable_div">
      <template:read var="delete-current-books()"/>
      <TABLE class="rTable_table">
      <t:loop>
      <TR>
      <TD>{book := object(),
           book.extendid := encode-for-uri(input/@name)
           }</TD>
      <TD>{book.duedate := parse-date(., "dd.mm.yyyy")}</TD>
      <TD>{book.libraryBranch := .}</TD>
      <TD>{book.category := filter(text(), "\[(.*)\]", 1),  
           book.title :=  if (contains(text(), "]")) then filter(text(), "(\] )(.*)", 2) else text(),
           if (contains($book.title, "/")) then (
             $book.author := substring-after($book.title, "/"),
             $book.title := substring-before($book.title, "/")
           ) else ()
           }<BR/>
          {preid := text()}<BR/>
          {book.id := concat($preid,":",text())}</TD>
      <TD>{book.status := deep-text("   ")}
          <t:if test="matches(., x'((nicht +verl.*ngerbar|Keine Verl.*gerung +m.*glich).*Stand +{string-join(reverse(tokenize(current-date(), '-')), '[.]')})|(Max. +Anzahl +der +Verl.*erreicht)','i')">
            {book.statusId := "critical"}
          </t:if>
      </TD>
      </TR>
      </t:loop>
      </TABLE>

      </DIV>
      </DIV>


      </form>
      </div>
    </template>
  </page>
  
  
</action>

<action id="renew-list">
  <variable name="book-list">string-join(for $book in $renew-books return x"{$book.extendid}=on", "&amp;")</variable> 
  <page url="{$extendFormPost}">
    <post value="{$book-list}"/>
  </page>
  
  <call action="update-all"/>
</action>













<action id="gotoindex">
  <loop test="$firstIndex > $targetIndex">
    <page url="{$form.url}" templateFile="searchBasicForm">
      <post value="{$form.post}&%24Toolbar_4.x=0&%24Toolbar_4.y=0"/>
    </page>
  </loop>

  <loop test="$lastIndex < $targetIndex">
    <page url="{$form.url}" templateFile="search">
      <post value="{$form.post}&%24Toolbar_5.x=0&%24Toolbar_5.y=0"/>
    </page>
  </loop>
  
</action>

<action id="search">
  <variable name="connected">false()</variable>
  
  <page url="https://{$server}/aDISWeb/app{get('startparams', '')}" templateFile="connected"/> <!-- some libraries log in directly, some redirect -->
  <page url="{$connectPage}" test="not($connected)" templateFile="connected"/>
  
  <page url="{$seachPage}">
    <template><form>
    <template:meta default-text-matching="regex"/>
    <t:switch><label>Titel</label>       <option>Titel</option>   </t:switch>   <input>{$nameTitle := @name}</input>
    <t:switch><label>Person|Name</label> <option>Autor</option>   </t:switch>   <input>{$nameAuthor := @name}</input>
    <t:switch><label>ISBN</label>        <option>ISSN</option>    </t:switch>   <input>{$nameIsbn := @name}</input>
    <t:switch><label>Schlag</label>      <option>Schlag</option>  </t:switch>   <input>{$nameKeywords := @name}</input>
    <label>[jJ]ahr</label>     <input>{$nameYear := @name}</input>
    {
      startSearch := form(., {
        $nameTitle: $book.title,
        $nameAuthor: $book.author,
        $nameIsbn: $book.isbn,
        $nameKeywords: $book.keywords,
        $nameYear: $book.year
      })
    }</form></template>
  </page>

  <variable>lastSearchedIndex := 0</variable>

  <page url="{$startSearch}" templateFile="search"/>
</action>

<action id="search-next-page">
  <variable name="targetIndex">$lastSearchedIndex + 1</variable> <call action="gotoindex"/>
</action>


<action id="search-details">
  <variable name="targetIndex">$book._index * 1</variable> <call action="gotoindex"/>

    <page url="{$form.url}">
    <post>{replace($form.post, "selected=", concat("selected=", $book._searchId))}</post>
    
    <template><html>
    <template:meta default-text-matching="regex"/>
    
    <DIV id="right">
      <DIV class="inside">
        <DIV id="R30">
          <DIV class="html_div">
            <div id="R001">
              <a><img>{book.image-url:=@src}</img></a>
            </div>
          </DIV>
        </DIV>
      </DIV>
    </DIV>?

    <a title="Trefferliste">{goback:=@href}</a><!--inside main in munich, outside in nürnberg-->
    
    
<!--    <DIV id="main">
      <DIV class="inside">
        <DIV class="block">
          <DIV class="fsgrp">-->
              <DIV class="aDISListe">
                <DIV class="html_div">
                  <DIV class="aDISListe">
                    <TABLE class="gi">
                      <t:loop>
                        <t:switch>
                        <TR>
                          <TH class="spaltelinks">Titel</TH>
                          <TD class="spalterechts">{book.title:=.}</TD>
                        </TR>
                        
                        <TR>
                          <TH class="spaltelinks">Person|Autor</TH>
                          <TD class="spalterechts">{book.author:=.}</TD>
                        </TR>
  
                        <TR>
                          <TH class="spaltelinks">erschienen</TH>
                          <TD class="spalterechts">{book.year:=translate(., "[]", "")}</TD>
                        </TR>
  
                        <TR>
                          <TD class="spalterechts"><a href="{$book.home-url}">Zitierlink</a></TD>
                        </TR>

                        <TR>
                          <TH class="spaltelinks">{name:=translate(normalize-space(.), ".", "")}</TH>
                          <TD class="spalterechts"><t:read source="." var="book.{$name}!"/></TD>
                        </TR>
                        </t:switch>
                      </t:loop>
                    </TABLE>
                  </DIV>
                </DIV>
              </DIV>
  
            <DIV class="rTable_div" template:optional="true">
              {exemplarCount := 0}
              <TABLE class="rTable_table">
                <thead/>
                <TR>
                  {exemplarCount := $exemplarCount + 1}
                  <t:read source="string-join(./td, ',  ')" var="book.Exemplar {$exemplarCount}!"/>
                </TR>*
              </TABLE>
            </DIV>
  
       <!--   </DIV>
        </DIV>
      </DIV>
    </DIV>-->
    
    </html></template>
  </page>
  
  <page url="{$goback}" templateFile="searchBasicForm"/>
  
</action>

</actions>
