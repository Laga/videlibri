<?xml version="1.0" encoding="UTF-8"?>
<actions>
<action id="connect"></action>

<action id="update-all">

  <page url="https://{$server}/aDISWeb/app"> <template>
     <meta http-equiv="refresh">{connectPage:=extract(@content, "url=(.*)", 1)}</meta>
  </template> </page>
  <page url="{$connectPage}">
  <template>
    <a><span>Benutzerkonto</span>{loginForm:=@href}</a>
  </template>
  </page>

  <page url="https://{$server}/{$loginForm}">
    <template><form>{
      loginFormPost := form(., {"$Textfield": $username, "$Textfield$0": $password})
    }</form></template>
  </page>


  <page url="{$loginFormPost}">
    <post name="textButton" value="Anmeldung abschicken"/>
    
    <template>
      <form>{loginFormPost:=form(.)}
      <h1>Sie sind angemeldet.</h1>
      </form>
      
    </template>
  </page>
  
  
  <page url="{$loginFormPost}">  
    <template>
    <t:switch>
    <a>Ausleihen zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    <a>Ausleihe zeigen oder verlängern<t:s>kontoPage := @href</t:s></a>
    </t:switch>
      <!--<t:s>kontoPage := filter(@href, "(.*)&amp;requestCount", 1),
           requestCount := filter(@href, "requestCount=([0-9]+)", 1)
      </t:s>-->
    </template>
  </page>


  <page url="https://{$server}/{$kontoPage}">
    <template>
      <DIV class="aDISMaske"><!-- this page shows the books, but not if they are renewable. need to click on a button for that -->
      <FORM>
      {extendFormPost := form(., jn:object((.//input[@type = "submit" and contains(@value, "arkierte") and contains(@value, "ngern")])[1]/{string(@name): @value})),
      extendFormPost.post := replace($extendFormPost.post, "[a-zA-Z0-9]+=on&", "")
      }
      
        
      <DIV class="fsgrp">
      <DIV class="rTable_div">
      <template:read var="delete-current-books()"/>
      <TABLE class="rTable_table">
      <t:loop>
      <TR>
      <TD>{book := object(),
           book.extendid := encode-for-uri(input/@name)
           }</TD>
      <TD>{book.duedate := parse-date(., "dd.mm.yyyy")}</TD>
      <TD><!--bib skip--></TD>
      <TD>{book.category := filter(text(), "\[(.*)\]", 1),  
           book.title :=  if (contains(text(), "]")) then filter(text(), "(\] )(.*)", 2) else text(),
           if (contains($book.title, "/")) then (
             $book.author := substring-after($book.title, "/"),
             $book.title := substring-before($book.title, "/")
           ) else ()
           }<BR/>
          {preid := text()}<BR/>
          {book.id := concat($preid,":",text())}</TD>
      <TD>{book.status := deep-text("   ")}
          <t:if test="matches(., x'((nicht +verl.*ngerbar|Keine Verl.*gerung +m.*glich).*Stand +{string-join(reverse(tokenize(current-date(), '-')), '[.]')})|(Max. +Anzahl +der +Verl.*erreicht)','i')">
            {book.statusId := "critical"}
          </t:if>
      </TD>
      </TR>
      </t:loop>
      </TABLE>

      </DIV>
      </DIV>


      </form>
      </div>
    </template>
  </page>
  
  
</action>

<action id="renew-list">
  <variable name="book-list">string-join(for $book in $renew-books return x"{$book.extendid}=on", "&amp;")</variable> 
  <page url="{$extendFormPost}">
    <post value="{$book-list}"/>
  </page>
  
  <call action="update-all"/>
</action>

</actions>
