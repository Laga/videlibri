<t:if> 
<!-- no wrapping form/fieldset, due to invalid /html closing tag in mannheim. 
    t:if makes it a valid xml file -->
  <template:meta default-text-matching="regex"/>
  
  {selections := true()}
  
  <fieldset id="OPACGP" t:optional="true"> <!-- nÃ¼rnberg -->
    <label>Titel</label>       <input>{$nameTitle := @name}</input>
    <label>Person|Name</label> <input>{$nameAuthor := @name}</input>
    <label>ISBN</label>        <input>{$nameIsbn := @name}</input>
    <label>Schlag</label>      <input>{$nameKeywords := @name}</input>
    <label>[jJ]ahr</label>     <input>{$nameYear := @name}</input>
    
    {
      startSearch := form(//form, {
        $nameTitle: $book.title,
        $nameAuthor: $book.author,
        $nameIsbn: $book.isbn,
        $nameKeywords: $book.keywords,
        $nameYear: $book.year
      }),
      selections := false()
    }
  </fieldset>
  
  <t:if test="$selections"> <!-- everything else (cannot use switch-prioritized due to broken html closing tag in mannheim) -->
    {search-keys := {}, selects := (), inputs := () }
    <select>{$selects := ($selects, @name)} <option>Titel<t:s>$search-keys.title := @value</t:s></option>   </select>   
    <input>{$inputs := ($inputs, @name)}</input>
    <select>{$selects := ($selects, @name)} <option>Person|Autor<t:s>$search-keys.author := @value</t:s></option>   </select>   
    <input>{$inputs := ($inputs, @name)}</input>
    <select>{$selects := ($selects, @name)} <option>ISBN|ISSN<t:s>$search-keys.isbn := @value</t:s></option>    </select>   
    <input>{$inputs := ($inputs, @name)}</input>
    <select>{$selects := ($selects, @name)} <option>Schlag|Thema<t:s>$search-keys.keywords := @value</t:s></option>  </select>   
    <input>{$inputs := ($inputs, @name)}</input>
    
    
    <label>[jJ]ahr</label>     <input>{$nameYear := @name}</input>

    {
      if ($book.keywords != "" and not($selects[last()]/../following::input[1] is $inputs[last()])) then (
         $selects := ($selects[position() le 3], $selects[3]), 
         $search-keys.keywords := ($selects[last()]/..//option[matches(., "Schlag|Thema")]/@value)[1],
         $inputs := ($inputs[position() le 3], $inputs[3])
      ) else (),
      i := 1,
      startSearch := form(//form, {|
        { $nameYear: $book.year },
          for $key at $i in ("title", "author", "isbn", "keywords") where (boolean($book($key)) and exists($search-keys($key))) 
          return  {$selects[$i]: $search-keys($key), $inputs[$i]: $book($key)}
        
      |})
            
    }
  </t:if>
</t:if>