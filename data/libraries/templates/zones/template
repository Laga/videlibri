<?xml version="1.0" encoding="UTF-8"?>
<actions>

<meta>
  <description>Template für das BiblioMonde-System</description>
  <variable name="baseurl"><description>Katalog-URL (inklusive .dll/, ohne Parameter)</description></variable>
  <variable name="style" default="Portal2"><description>Katalog-Style</description></variable>
</meta>


<action id="connect">
  <s>style := get('style', 'Portal2')</s>
  <page url="{$baseurl}/APS_OPAC?Style={$style}">
    <template>
      <a t:condition="matches(@href, '/APS_ACCOUNT|/APS_ZONES.*fn=Account')">{accountUrl := @href}</a>
    </template>
  </page>
</action>

<action id="search-connect">
 <!-- <page url="{$baseurl}/APS_OPAC?Style={get('style', 'Portal2')}">
    <template>
      <a t:condition="matches(@href, '/APS_QUICK_SEARCH')">{searchUrl := replace(@href, "QUICK_SEARCH", "ADVANCED_SEARCH")}</a>
    </template>
  </page>-->
  <s>style := get('style', 'Portal2')</s>

  <page url="{$baseurl}/APS_ZONES?fn=advancedsearch&Style={$style}"> 
    <template>
      <FORM NAME="ExpertSearch">{search-start:=form(.)}</form>
    </template>
  </page>
</action>

<action id="search"> 
  <variable name="search-keys">{"author": "au=", "title": "ti=", "keywords": "su=", "isbn": "sb=", "year": "dp="}</variable>
  
  <s>
    i := 1,
    request := uri-combine($search-start.url, 
      (for $key in jn:keys($book) return if ($book($key) != "" and exists($search-keys($key))) then (
              {x"q.form.t{$i}&#46;expr": $book($key), x"q.form.t{$i}&#46;term": $search-keys($key)},
              (i := $i + 1)[2]
            ) else () ) )
  </s>
  
  <page url="{$request}" templateFile="searchList">
  
  </page>
  <s>search-next-page-available := true()</s>
  <s>requestId := 1</s>  
</action>

<action id="search-next-page"> 
  <page url="{$baseurl}/{$obj}?Style={$style}&SubStyle=&Lang=GER&ResponseEncoding=utf-8&ResponseEncoding=utf-8&Method=FetchIncrementalBrowseDown&RequestId={$requestId}&" templateFile="searchListIncremental"/>
  <s>requestId := $requestId + 1</s>
</action>


<action id="search-details"> 
</action>


<action id="update-all">  
  <page url="{$accountUrl}">
    <template>
      <form name="LoginForm">
        {form := form(., {"BRWR": $username, "PIN": $password})}
      </form>
    </template>
  </page>
  
  <page url="{$form}" templateFile="loggedIn"/>
  
  <page url="{$bookListUrl}" templateFile="list"/> 
  
  <s>requestId := 1</s>
  
  <loop test="not($bFoundBottom)">
    <page url="{$baseurl}/{$obj}?Style={$style}&SubStyle=&Lang=GER&ResponseEncoding=utf-8&ResponseEncoding=utf-8&Method=FetchIncrementalBrowseDown&RequestId={$requestId}&" templateFile="listIncremental"/> 
    <s>requestId := $requestId + 1</s>
  </loop>
</action>

<action id="renew-list">  
  <s>renew-ids := for $book in $renew-books return x"item:IN={$book.id};AT={$book.author}/{$book.title}"</s>
  
  <page url="{$bulkRenew}" templateFile="bulkRenew"/>

  <s>renewConfirm := form-combine($baseForm, $options)</s>  
  <page url="{$renewConfirm}"/>
  
  <call action="update-all"/>  
  
</action>

<!--http://katalog.stadtbibliothek.luebeck.de/alswww2.dll/Obj_577491377434134?
dateReq=1377434653896-->
</actions>
