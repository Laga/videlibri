<html>

<template:meta default-text-matching="regex"/>
<t:s>curAuthor := (), sigid := 0, if (get("singleResult", false())) then book:={} else (), book.orderable := 0</t:s> <!-- extra variable to prevent contamination by previously set book.author -->


<table summary="Main layout">
  
  <template:switch-prioritized>
  
  <table t:condition="exists((. | ./tbody)/tr/td[contains(@class, 'preslabel')])">
  <template:loop><template:switch>
    <tr>
      <td><strong>^[ ]*Titel:</strong></td>
      <td>{book.title := extract(deep-text(''), '[^/]+')}</td>
    </tr>
    
    <tr>
      <td><strong>Verfasser|Personen</strong></td>
      <td>{curAuthor := ($curAuthor, extract(deep-text(''), '[^*]+') ),
           book.author := string-join($curAuthor, "; ")}</td>
    </tr>
    
    <tr>
      <td><strong>ISBN:</strong></td>
      <td>{$book.isbn := text()}</td>
    </tr>

    <tr>
      <td><strong>PPN:</strong></td>
      <td><a>{$book.home-url := if (contains(@href, "://")) then @href else concat(get("base"),"/",@href)}</a></td>
    </tr>
    
    <tr>
      <td><strong>Zeitschrift:</strong></td>
      <td>{temp := deep-text(""),
           book.title := concat(if (contains($temp, ":")) then substring-before($temp, ":") else $temp, 
                                if (contains($book.id, "-")) then concat(" [",substring-after($book.id, "-"), "]") else ""),
           book.author := if (contains($temp, "/")) then x"{substring-after(normalize-space($temp), "/")} (Zeitschrift)" else "Zeitschrift"}</td>
    </tr>

    <tr>
      <td><strong>KÃ¶rperschaft:</strong></td>
      <td>{if ($book.author = "Zeitschrift") then book.author := concat(., " (Zeitschrift)") else ()}</td>
    </tr>
    
    
    <tr>
      <td><strong>Standort:</strong></td>
      <td><t:read var="book.Standort {$sigid + 1}!" source="."/></td>
    </tr>

    <tr>
      <td><strong>Signatur:</strong></td>
      <td>{sigid := $sigid + 1}<t:read var="book.Signatur {$sigid}!" source="."/></td>
    </tr>
    
    <tr>
      <td><strong>(Ausleih)?status:</strong></td>
      <td><t:read var="book.Ausleihstatus {$sigid}!" source="string-join(div/text(), '; ')"/>
        <script><t:read var="book.order{$book.orderable}" source="extract(., '(/loan[^'']*)\\''', 1)"/><!-- source="extract(., '(/loan.*)LOGIN', 1)"/> -->
                <t:read var="book.orderTitle{$book.orderable}" 
                        source="concat($book(x'Standort {$sigid}!'), ' ',$book(x'Signatur {$sigid}!'), ' ', $book(x'Ausleihstatus {$sigid}!') )"/> 
                {book.orderable := $book.orderable + 1, book.orderTitle := extract(., ">([^>]*)&lt;/a>", 1)}</script>?</td>
    </tr>
    
    <tr>
      <td><strong>{propname := extract(translate(normalize-space(.), ".", ""), "[^:]+")}</strong></td>
      <td><t:if test="$propname != ''"><t:read var="book.{$propname}!" source="."/></t:if></td>
    </tr>
  </template:switch></template:loop>
  
  { let $longproperties := ./ancestor::table[@summary][1]/following-sibling::table//tr[td[@class="longkey"]]/[.//td[@class="longkey"], td[@class="longval"] ]
    where exists($longproperties)
    return $book.holdings := (
      for tumbling window $w in $longproperties start $s when empty($s(2)//hr) end next $n when exists($n(2)//hr)
      return (
        {| $w / {.(1) || "!": .(2)/join((., .//a/x" ( {@href} ) "))},
         {"orderable": false()} |}
      )
    )
  }
  
  </table>
  
  <strong>Leider keine Treffer.</strong>
  <font t:condition="contains(@style, 'red')">Leider keine Treffer.</font>
  
  <!-- for un-unique results -->
  <table summary="hitlist">
      
    <tr valign="top">
      <td></td> <!-- icon -->
      <td></td> <!-- number -->
      <td class="hit">
        <a>{book.title := deep-text()}</a>
        <br/>
        {book.author := extract(text(), " */? *-? *([^-]*)", 1) ,
                       (: replace(text(), "( *([-,.])? *\[?(ca[.] *)?[0-9]{4}( *- *)?([0-9]{4})?\]?)$", "") :)
         book.year   := extract(text(),             "(\[?(ca[.] *)?[0-9]{4}( *- *)?([0-9]{4})?\]?)$", 1)
        } 
      </td>
    </tr>
  </table>
      
  
  </template:switch-prioritized>
  
  <img t:condition="contains(@src, 'permalink')">  <!-- permalink.gif, or permalink_du.gif, ... -->
  {book.home-url:=if (contains(../@href, "://")) then ../@href else concat(get("base", ""),"/",../@href)}
  </img>?
  
  
</table>



</html>
