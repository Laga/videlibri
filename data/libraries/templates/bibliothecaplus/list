<html>
  {culture := (//input[contains(@name, "Culture")], "de-DE")[1]/@value, vl:delete-current-books() }
  <link t:condition="contains(@href, 'PatronAccountModule')">{extendableCheck := extract(resolve-uri(@href), "^.*PatronAccountModule[/\\]") || "PatronAccountService.asmx/IsCatalogueCopyExtendable"}</link>
  
  <form>
    { $user-form := form(.),
      $renew-button := (//input[ends-with(@name, "BtnExtendMediums")])[1]/{"__EVENTTARGET":  @name},
      $cancel-ordered-button := (//input[ends-with(@name, "BtnCancelReservations")])[1]/{"__EVENTTARGET":  @name},
      $cancel-provided-button := (//input[ends-with(@name, "BtnCancelReadyForPickup")])[1]/{"__EVENTTARGET":  @name},
      $hasBranches := false(),
      $portalId := (extract($raw, 'eonportalid *= *[''"]([0-9]+)[''"]', 1)[.], 1)[1]
    }
    
    <TABLE t:condition="contains(@id, 'grdViewLoans')"> <!-- also in @id -->
      <t:switch prioritized="true">
        <tr><th/><a t:condition="contains(@href, 'Sort$Branch')">{$hasBranches := true}</a>?</tr>
        <tr class="GridViewInnerBorderNoData"/>
        <tr class="oclc-module-table-nodata"/>
      </t:switch>
      <t:loop>
        <TR>
          <TD><INPUT>{book := {"_renewid": @name}}</INPUT></TD>
          <TD>{$book.image-url := .//(img,input[type="image"])!(@src, tokenize(@sources, "[|]")[contains(.,"://")]),
               $book.image-url!extract(., "(amazon.*/(ASIN|P)/|isbn=)([-0-9]+)[./&amp;]", 3)[.][1]!($book.ISBN := .)
           }</TD>
          <TD>{book.title := .}</TD>
          <TD>{book.author := .}</TD>
          <TD>{book.category := .}</TD>
          <TD t:test="$hasBranches">{book.libraryBranch := .}</TD>
          <TD>{book.duedate := parse-date(extract(., "[0-9./-]+"))}</TD>
          <div class="extendableRegion"><input t:condition="contains(@name, 'CopyId')">{book._copyId := @value, book.id := @value}</input></div>?
        </TR>
      </t:loop>
    </TABLE>             
  
  
    <table t:condition="contains(@id, 'grdViewReservations')">
      <t:switch prioritized="true">
        <tr><th/></tr>
        <tr class="GridViewInnerBorderNoData"/>
        <tr class="oclc-module-table-nodata"/>
      </t:switch>
      <tr><td><input>{book := {"_cancelid": @name, "statusId": "ordered", "cancelable": true()}}</input></td>
          <TD/><!--<input type="image" src=".."/>-->
          <TD>{book.title := .}</TD>
          <TD>{book.author := .}</TD>
      </tr>*
    </table>
           
    
  	<table t:condition="contains(@id, 'grdViewReadyForPickups')">
      <t:switch prioritized="true">
        <tr><th/></tr>
        <tr class="GridViewInnerBorderNoData"/>
        <tr class="oclc-module-table-nodata"/>
      </t:switch>
      <tr><td><input>{book := {"_cancelid": @name, "statusId": "provided", "cancelable": true()}}</input></td>
          <TD/><!--<input type="image" src=".."/>-->
          <TD>{book.title := .}</TD>
          <TD>{book.author := .}</TD>
      </tr>* <!-- todo: correct columns???-->
  	</table>
    
  </form>
</html>
