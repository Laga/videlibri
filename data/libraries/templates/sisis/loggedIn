<html>
<head>
<template:read source="''" var="bookCount"/>
<template:read source="get('nextPage', '')" var="nextPage"/>
<template:read source="get('startUrl', '')" var="startUrl"/>
</head>
<body>
   <div id="main"> 
     <div id="middle"> 
      <div id="tab">
        <div>Ausleihen<t:s>bookCountLend := extract(., "[0-9]+")</t:s></div>
        <div>Bestellungen<t:s>bookCountRequested := extract(., "[0-9]+"), requestedUrl := a/@href</t:s></div>?
        <div>Vormerkungen<t:s>bookCountOrdered := extract(., "[0-9]+"), orderedUrl := a/@href</t:s></div>?
      </div>
        
  <div id="tab-content">
  

    <div class="box">
      <div class="box-header">
        <template:switch>
          <h2>Ausleihen
             <t:s>bookCount := $bookCountLend, mode := 1</t:s>
             <t:if test="$nextPage = ''"><template:read var="delete-current-books()"/></t:if></h2>
          <h2>Bestellungen<t:s>bookCount := $bookCountRequested, mode := 2</t:s></h2>
          <h2>Vormerkungen<t:s>bookCount := $bookCountOrdered, mode := 3</t:s></h2>
        </template:switch>
      </div>
    </div>
    <!--<fieldset>-->

    <t:if test="$nextPage != ''">{nextPage := ""}</t:if>

<!--    <template:if test="$allBooksAway=''">-->
    <table class="data">
      <tr>
        <th scope="col"></th>
      </tr>

      <template:loop>      

      <tr>
        <th scope="row"></th>
        {book := object()}
        <td>
          <strong><template:read source="." var="book.title"/></strong><br/>
          <!-- <template:read source="true()" var="spanmissing"/>
         <template:read source="false()" var="previousspan"/>-->
          <template:read source="text()" var="book.author"/><br/>
          <template:read source="text()" var="book.id" regex="^[^/]*"/><br/>
          <a template:optional="true">
            <template:read source="@href" var="book.extendID" regex="actPos=([0-9]+)$" submatch="1"/>
            <span>
              <template:read source="." var="book.status:curious"/>
            <!--  <template:read source="@class != 'textgruen'" var="spanmissing"/>-->
            </span>
            {book._onPage := $url, book._onPageStart := $startUrl}
          </a>
          <span template:optional="true">
            <template:read source="." var="book.status:problematic"/>
            <!--<template:read source="false()" var="spanmissing"/>
            <template:read source="true()" var="previousspan"/>-->
          </span>
          <a template:optional="true">
            {book.extendID := extract(@href, "actPos=([0-9]+)$", "1"),
             book.statusId := if ($mode eq 3) then "ordered" else if ($mode eq 2) then "provided" else "curious",
             book.cancelable := $mode eq 3,
             book._onPage := $url, book._onPageStart := $startUrl}          
          </a>
<!--	  <template:if test="$previousspan">
	    <span template:optional="true">
              <template:read source="concat(x"$book.status:problematic ", text())" var="book.status:problematic"/>
              <template:read source="false()" var="spanmissing"/>
            </span>
           </template:if>-->
         </td>
      <!--   <template:if test="$spanmissing"><broken/></template:if>-->
         <template:switch>
           <td>bestellt<br/>
              <t:s>book.status := ./text()[1],
                   book.issuedate := parse-date(extract(., '\d{2}\.\d{2}\.\d{4}', 0), 'dd.mm.yyyy|'), 
                   book.statusId := "ordered",
                   book.cancelable := boolean($book.extendID) </t:s>
           </td>
           <td>abholbar<br/>
              <t:s>book.status := ./text()[1],
                   book.issuedate := parse-date(extract(., '\d{2}\.\d{2}\.\d{4}', 0), 'dd.mm.yyyy|'), 
                   book.statusId := "provided",
                   book.cancelable := boolean($book.extendID)</t:s>
           </td>
           <td>
             {book.issuedate:=parse-date(extract(., '(\d{2}\.\d{2}\.\d{4}) *-', 1), 'dd.mm.yyyy'),
              book.duedate:=parse-date(extract(.,'- *(\d{2}\.\d{2}\.\d{4})', 1), 'dd.mm.yyyy')
             }
           </td>
         </template:switch>
       </tr>
              
      </template:loop>      
               
      </table>
  <!--    </template:if>-->
    <!-- </fieldset> -->
      <div class="box"><div class="box-header"><div class="box-right">
        {let $selected := .//span[contains(@class, "selectedlink")] return
         nextPage := $selected[if (count($selected) ge 2) then 2 else 1]/following-sibling::a[1]/@href  }
        <!--<span class="selectedlink" t:condition="not(contains(text(), '&#171;'))"/>
        <a>{nextPage:=@href}</a>-->
      </div></div></div>?
   </div>
  </div>
 </div>
</body>
</html>
  
