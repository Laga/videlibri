<?xml version="1.0" encoding="UTF-8"?>
<actions>


<meta>
  <description>Template für das Sisis-System</description>
  <variable name="server"><description>Serveraddresse (inklusive Protokoll)</description></variable>
  <variable name="startparams" default=""><description>Parameter für den Aufruf des Web-OPACs, falls mehrere Bibliotheken auf dem Server existieren (inklusive "?")</description></variable>
</meta>

<action id="catalogue">
  <variable name="url" value="{$server}start.do{get('startparams','')}"/>
</action>

<action id="connect">
  <page url="{$server}start.do{get('startparams','')}" templateFile="start"/>
</action>

<action id="login">
  <page url="{$server}login.do;{$jsession}">
    <post name="methodToCall" value="submit"/>
    <post name="CSId" value="{$CSId}"/>
    <post name="username" value="{$username}"/>
    <post name="password" value="{$password}"/>
    
    <template>
    <body>
    <a t:optional="true">deutsch<t:if test="/html/@lang != 'de'">
        <t:read var="raise()" source="concat('VideLibri funktioniert nur, wenn die Sprache des Webkatalogs auf deutsch gesetzt ist.', $line-ending, 'Die Einstellung kann auf der normalen Katalogseite unter Konto / Sucheinstellungen / Sprache geändert werden.', $line-ending, $line-ending, $line-ending, 'VideLibri only works, if the language of the library web catalog is set to German. ', $line-ending, ' You can change the language setting on the normal web page on the  Account / Search preferences / Language page.')"/>
    </t:if></a>
    <form id="LoginBean" t:optional="true">
      <div class="error"><t:read var="raise-login()" source="."/></div>
    </form>
    </body>
    </template>
  </page>
</action>

<action id="update-all">
  <call action="login"/>
  
  <variable name="requestedUrl" value=""/>
  <variable name="orderedUrl" value=""/>

  <page url="{$server}userAccount.do;jsession;?methodToCall=show&amp;typ=1"  templateFile="loggedIn"></page>
  <loop test="$nextPage != ''">
    <page url="{$nextPage}"  templateFile="loggedIn"></page>
  </loop>

  <page url="{$requestedUrl}"  templateFile="loggedIn"></page>
  <loop test="$nextPage != ''">
    <page url="{$nextPage}"  templateFile="loggedIn"></page>
  </loop>

  <page url="{$orderedUrl}"  templateFile="loggedIn"></page>
  <loop test="$nextPage != ''">
    <page url="{$nextPage}"  templateFile="loggedIn"></page>
  </loop>
  <!--  <error templateFile="loginError"/>-->
</action>


<action id="renew-single">
  <page url="{$server}userAccount.do?methodToCall=renewalPossible&amp;actPos={$book.extendID}" templateFile="singleExtended"/>
</action>

<action id="cancel-single">
  <page url="{$server}userAccount.do?methodToCall=cancelReservation&amp;actPos={$book.extendID}"/>
<!--  <template>      	 <span class="textgruen"><strong>Stornierung durchgeführt</strong></span></br></template>-->
</action>


<!--<action id="renew-all">
  <page url="{$server}AusleiheVerlaengerungServlet;{$jsession}" templateFile="KontoServlet">
    <post name="Kontoart" value="Ausleihkonto"/>
    <post name="Bibliothek" value="111"/>
    <post name="homegkz" value="111"/>
  </page>
</action>-->

<action id="search-connect">
  <call action="connect"/>
</action>


<action id="search">

  <variable name="searchOptions">
  (if ($book.title != "")    then ["331", uri-encode($book.title)]    else (),
   if ($book.author != "")   then ["100", uri-encode($book.author)]   else (),
   if ($book.isbn != "")     then ["540", uri-encode($book.isbn)]     else (),
   if ($book.year != "")     then ["425", uri-encode($book.year)]     else (),
   if ($book.keywords != "") then ["902", uri-encode($book.keywords)] else ())
  </variable>

  <variable name="searchUrl">
  concat(x"{$server}search.do?methodToCall=submit&CSId={$CSId}&methodToCallParameter=submitSearch&",
         x"searchCategories%5B0%5D={$searchOptions[1](1)}&searchString%5B0%5D={$searchOptions[1](2)}&",
         if (count($searchOptions) > 1) then x"combinationOperator%5B1%5D=AND&searchCategories%5B1%5D={$searchOptions[2](1)}&searchString%5B1%5D={$searchOptions[2](2)}&" else "",
         if (count($searchOptions) > 2) then x"combinationOperator%5B2%5D=AND&searchCategories%5B2%5D={$searchOptions[3](1)}&searchString%5B2%5D={$searchOptions[3](2)}&" else "",
         "submitSearch=Suchen&callingPage=searchParameters"
  )
  </variable>

  <variable name="nextPage" value=""/>
  <variable name="singleBookResult" value=""/>
  
  <page url="{$searchUrl}" templateFile="searchList"/>

  <page test="$singleBookResult != ''"  url="{$singleBookResult}" templateFile="searchSingle"/>
  
  <variable name="search-next-page-available">$nextPage != ''</variable>
</action>

<action id="search-next-page">
  <page url="{$nextPage}" templateFile="searchList"></page>
  <variable name="search-next-page-available">$nextPage != ''</variable>
</action>

<action id="search-details">
  <page url="{$book._detail-url}&amp;tab=showTitleActive" templateFile="searchSingle"/>
</action>


<action id="order-single"> 
  <if test="not(get('loggedIn', false()))"> 
    <call action="login"/>
    <variable name="loggedIn">true()</variable>
  </if>
  
  <page url="{$book.order0}">
    <template><t:s>order := form(//form[contains(@action, "availability")])</t:s></template>
  </page>
  
  <page url="{$order}">
    <template><t:s>confirm := form(//form[contains(@action, "reservation")])</t:s></template>
  </page>
  
  <page url="{$confirm}">
<!--    <template>          Das Medium wurde für Sie vorgemerkt
    und ist voraussichtlich bis </template>-->
  </page>
</action>

</actions> 
